# SportBuddy Backend

## Актуальный прогресс (июль 2025)

- Реализована авторизация через Telegram (deep linking, бот, polling)
- Хранение профиля пользователя в PostgreSQL (имя, био, интересы, спорт, pet, avatar_url)
- Загрузка и хранение аватара пользователя через Yandex Object Storage (S3-совместимый бакет)
- Эндпоинты для получения и обновления профиля (`/user/:telegram_id`, `/user/:telegram_id/avatar`)
- Интеграция с Flutter-приложением: вход, редактирование профиля, загрузка аватара
- Переменные окружения для Railway и Yandex Object Storage вынесены в .env/Variables
- Базовая структура для событий (events) и будущих функций заложена
- **Добавлен автоматический миграционный скрипт для создания всех нужных таблиц при запуске backend**
- **Поддержка сохранения и обновления профиля с фото и текстовыми полями**
- Проект синхронизирован с [https://github.com/scrashm/SportBuddy](https://github.com/scrashm/SportBuddy)

---

## Описание

Бэкенд для приложения SportBuddy с авторизацией через Telegram (deep linking + подтверждение через бота).

### Реализовано на данный момент
- Вход через Telegram с помощью уникального токена и deep link (`/auth/telegram/start`)
- Подтверждение входа через Telegram-бота (бот слушает /start и кнопку "Подтвердить вход")
- Проверка статуса входа по токену (`/auth/telegram/status/:token`)
- Тестовый маршрут для проверки подключения к базе данных (`/test-db`)
- Сохранение и обновление профиля пользователя, включая загрузку аватара

## Алгоритм входа через Telegram
1. Пользователь нажимает "Войти через Telegram" в приложении.
2. Приложение запрашивает ссылку для входа через `/auth/telegram/start`.
3. Пользователь переходит по deep link в Telegram, бот получает команду `/start token_xxx`.
4. Бот отправляет пользователю кнопку "Подтвердить вход".
5. Пользователь нажимает кнопку, бот сообщает серверу о подтверждении.
6. Приложение опрашивает `/auth/telegram/status/:token` и, получив статус `confirmed`, завершает вход.

## API

### POST `/auth/telegram/start`
- Генерирует токен и deep link для входа через Telegram.
- Ответ: `{ url, token }`

### GET `/auth/telegram/status/:token`
- Проверяет статус входа по токену.
- Ответ: `{ status: 'pending' | 'waiting_confirm' | 'confirmed' | 'not_found', telegram_id?, telegram_username? }`

### GET `/test-db`
- Проверка подключения к базе данных.

### POST `/user/:telegram_id`
- Обновление профиля пользователя (имя, био, интересы, pet, avatar_url и др.)

### POST `/user/:telegram_id/avatar`
- Загрузка аватара пользователя (multipart/form-data)
- Ответ: `{ avatarUrl }`

## Миграции и структура БД

- При запуске backend автоматически создаются все необходимые таблицы и расширения (см. временный миграционный скрипт в server.js).
- Если база новая — ничего дополнительно делать не нужно.

## Как протестировать
1. Запросить ссылку через `/auth/telegram/start` (POST).
2. Перейти по ссылке, нажать Start и "Подтвердить вход" в Telegram.
3. Проверять статус токена через `/auth/telegram/status/:token` (GET).
4. После подтверждения получить Telegram ID и username для дальнейшей авторизации.
5. Сохранить профиль с текстовыми полями и фото через соответствующие эндпоинты.

---

**Внимание:**
- Для production рекомендуется хранить токены входа и их статусы в Redis или базе данных, а не в памяти.
- Для полноценной регистрации пользователя стоит добавить сохранение профиля в БД после подтверждения входа.

---

Проект синхронизирован с [https://github.com/scrashm/SportBuddy](https://github.com/scrashm/SportBuddy) 